# ุงููุธุงู ุงููุงูู ุงูููุญุฏ - TrColors

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุงูู ููุญุฏ ูุฑุจุท ุงูุฅูุตุงูุงุช ูุงูููุงุชูุฑ ูุงูุตูุฏูู ูู ููุธููุฉ ูุงุญุฏุฉ ูุน ุชุชุจุน ูุงูู ููู ุนูููุฉ.

---

## ุงููููุงุช ุงููููุดุฃุฉ ูุงูููุนุฏููุฉ

### Backend (ุงูุณูุฑูุฑ)

#### ุงูููุงุฐุฌ ุงูุฌุฏูุฏุฉ (Models)
| ุงูููู | ุงููุตู |
|-------|-------|
| `server/src/models/Transaction.js` | ูููุฐุฌ ุงููุนุงููุงุช ุงููุงููุฉ ุงูููุญุฏ - ูุณุฌู ูู ุญุฑูุฉ ูุงููุฉ |
| `server/src/models/Receipt.js` | ูููุฐุฌ ุงูุฅูุตุงูุงุช - ูุณุชูู ุนู ุงูููุงุชูุฑ |
| `server/src/models/InvoicePayment.js` | ูููุฐุฌ ุฏูุนุงุช ุงูููุงุชูุฑ - ูุชุชุจุน ูู ุฏูุนุฉ ุนูู ุญุฏุฉ |
| `server/src/models/AuditLog.js` | ูููุฐุฌ ุณุฌู ุงูุชุฏููู - ูุชุชุจุน ูู ูุนู ูุงุฐุง ููุชู |

#### ุงููููุฐุฌ ุงูููุนุฏูู
| ุงูููู | ุงูุชุนุฏููุงุช |
|-------|----------|
| `server/src/models/Invoice.js` | ุฅุฒุงูุฉ ููุน 'receipt'ุ ุฅุถุงูุฉ ุญูู payments ู originalReceipt |

#### Controllers
| ุงูููู | ุงููุตู |
|-------|-------|
| `server/src/controllers/transactionController.js` | ุฅุฏุงุฑุฉ ุงููุนุงููุงุช (ุฅูุดุงุกุ ุนุฑุถุ ุฅูุบุงุกุ ุฅุญุตุงุฆูุงุช) |
| `server/src/controllers/receiptController.js` | ุฅุฏุงุฑุฉ ุงูุฅูุตุงูุงุช (ุฅูุดุงุกุ ุชุญููู ููุงุชูุฑุฉุ ุฅูุบุงุก) |
| `server/src/controllers/auditController.js` | ุนุฑุถ ุณุฌู ุงูุชุฏููู ูุงูุจุญุซ ููู |

#### ุงูููุนุฏูู
| ุงูููู | ุงูุชุนุฏููุงุช |
|-------|----------|
| `server/src/controllers/invoiceController.js` | ุฅุถุงูุฉ getPayments ู refundPaymentุ ุชุนุฏูู addPayment |

#### Routes
| ุงูููู | ุงููุตู |
|-------|-------|
| `server/src/routes/transactionRoutes.js` | ูุณุงุฑุงุช API ูููุนุงููุงุช |
| `server/src/routes/receiptRoutes.js` | ูุณุงุฑุงุช API ููุฅูุตุงูุงุช |
| `server/src/routes/auditRoutes.js` | ูุณุงุฑุงุช API ูุณุฌู ุงูุชุฏููู |

#### Utils
| ุงูููู | ุงููุตู |
|-------|-------|
| `server/src/utils/financialUtils.js` | ุฏูุงู ูุณุงุนุฏุฉ (ุชุญุฏูุซ ุงูุฑุตูุฏุ ุฅูุดุงุก ุณุฌู ุชุฏููู) |

#### Index Files
| ุงูููู | ุงูุชุนุฏููุงุช |
|-------|----------|
| `server/src/models/index.js` | ุชุตุฏูุฑ ุงูููุงุฐุฌ ุงูุฌุฏูุฏุฉ |
| `server/src/routes/index.js` | ุฅุถุงูุฉ ุงููุณุงุฑุงุช ุงูุฌุฏูุฏุฉ |

---

### Frontend (ุงููุงุฌูุฉ)

#### APIs
| ุงูููู | ุงููุตู |
|-------|-------|
| `client/src/api/transactionsApi.js` | API ูููุนุงููุงุช |
| `client/src/api/receiptsApi.js` | API ููุฅูุตุงูุงุช |
| `client/src/api/auditApi.js` | API ูุณุฌู ุงูุชุฏููู |

#### ุงูุตูุญุงุช ุงูุฌุฏูุฏุฉ
| ุงูููู | ุงููุตู |
|-------|-------|
| `client/src/pages/admin/Receipts.jsx` | ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุฅูุตุงูุงุช |
| `client/src/pages/admin/Receipts.css` | ุชูุณููุงุช ุตูุญุฉ ุงูุฅูุตุงูุงุช |
| `client/src/pages/admin/Transactions.jsx` | ุตูุญุฉ ุงูุณุฌู ุงููุงูู |
| `client/src/pages/admin/Transactions.css` | ุชูุณููุงุช ุงูุณุฌู ุงููุงูู |
| `client/src/pages/admin/AuditLog.jsx` | ุตูุญุฉ ุณุฌู ุงูุชุฏููู (ูููุฏุฑุงุก ููุท) |
| `client/src/pages/admin/AuditLog.css` | ุชูุณููุงุช ุณุฌู ุงูุชุฏููู |

#### ุงููููุงุช ุงูููุนุฏููุฉ
| ุงูููู | ุงูุชุนุฏููุงุช |
|-------|----------|
| `client/src/components/layout/Sidebar.jsx` | ุฅุถุงูุฉ ุฑูุงุจุท ุงูุฅูุตุงูุงุชุ ุงูุณุฌู ุงููุงููุ ุณุฌู ุงูุชุฏููู |
| `client/src/routes.jsx` | ุฅุถุงูุฉ ูุณุงุฑุงุช ุงูุตูุญุงุช ุงูุฌุฏูุฏุฉ |
| `client/src/api/index.js` | ุชุตุฏูุฑ APIs ุงูุฌุฏูุฏุฉ |
| `client/src/api/invoicesApi.js` | ุฅุถุงูุฉ getPayments ู refundPayment |

---

## ุขููุฉ ุนูู ุงููุธุงู (Workflows)

### 1. ุฅูุดุงุก ุฅูุตุงู
```
ุงููุณุชุฎุฏู ููุดุฆ ุฅูุตุงู
    โ
ุงููุธุงู ููุดุฆ Receipt
    โ
ุงููุธุงู ููุดุฆ Transaction ุชููุงุฆูุงู (source: 'automatic')
    โ
ุชุญุฏูุซ ุฑุตูุฏ CashRegister
    โ
ุชุญุฏูุซ Customer.totalSpent (ุฅุฐุง ูุฑุชุจุท ุจุนููู)
    โ
ุฅูุดุงุก ุณุฌู ูู AuditLog
```

### 2. ุชุญููู ุฅูุตุงู ููุงุชูุฑุฉ
```
ุงููุณุชุฎุฏู ูุทูุจ ุชุญููู ุงูุฅูุตุงู
    โ
ุงูุชุญูู ูู ุฃู ุงูุฅูุตุงู status = 'active'
    โ
ุฅูุดุงุก Invoice ุฌุฏูุฏุฉ ูุน originalReceipt ref
    โ
ุฅูุดุงุก InvoicePayment ูู ูุจูุบ ุงูุฅูุตุงู
    โ
ุชุญุฏูุซ Receipt.status = 'converted'
    โ
ุฅูุดุงุก ุณุฌู ูู AuditLog
```

### 3. ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ
```
ุงููุณุชุฎุฏู ูุถูู ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ
    โ
ุฅูุดุงุก Transaction ุชููุงุฆูุงู
    โ
ุฅูุดุงุก InvoicePayment
    โ
ุชุญุฏูุซ Invoice.paidAmount ู payments array
    โ
ุชุญุฏูุซ ุฑุตูุฏ CashRegister
    โ
ุชุญุฏูุซ Customer.totalSpent
    โ
ุฅูุดุงุก ุณุฌู ูู AuditLog
```

### 4. ูุนุงููุฉ ูุฏููุฉ
```
ุงููุณุชุฎุฏู ููุดุฆ ูุนุงููุฉ ูุฏููุฉ (ูุตุฑูู/ุฅูุฑุงุฏ)
    โ
ุงูุชุญูู ูู ุงูุฑุตูุฏ (ูููุตุฑููุงุช)
    โ
ุฅูุดุงุก Transaction (source: 'manual')
    โ
ุชุญุฏูุซ ุฑุตูุฏ CashRegister
    โ
ุฅูุดุงุก ุณุฌู ูู AuditLog
```

---

## ุงูุตูุงุญูุงุช

| ุงูููุฒุฉ | Admin | Employee |
|--------|-------|----------|
| ุนุฑุถ ุงููุนุงููุงุช | ุงููู | ุงูุฎุงุตุฉ ุจู |
| ุฅูุดุงุก ูุนุงููุฉ ูุฏููุฉ | ูุนู (ูู ุงูุฃููุงุน) | ุฅูุฑุงุฏุงุช ููุท |
| ุฅูุบุงุก ูุนุงููุฉ | ูุนู | ูุง |
| ุฅูุดุงุก ุฅูุตุงู | ูุนู | ูุนู |
| ุฅูุบุงุก ุฅูุตุงู | ูุนู | ูุง |
| ุชุญููู ุฅูุตุงู ููุงุชูุฑุฉ | ูุนู | ูุนู |
| ุงุณุชุฑุฏุงุฏ ุฏูุนุฉ | ูุนู | ูุง |
| ุนุฑุถ ุณุฌู ุงูุชุฏููู | ูุนู | ูุง |

---

## ุทุฑููุฉ ุงูุงุฎุชุจุงุฑ

### 1. ุชุดุบูู ุงูุณูุฑูุฑ ูุงูุนููู

```bash
# Terminal 1 - ุชุดุบูู ุงูุณูุฑูุฑ
cd server
npm run dev

# Terminal 2 - ุชุดุบูู ุงูุนููู
cd client
npm run dev
```

### 2. ุงุฎุชุจุงุฑ APIs ุจุงุณุชุฎุฏุงู curl

#### ุงุฎุชุจุงุฑ ุฅูุดุงุก ุฅูุตุงู
```bash
curl -X POST http://localhost:5000/api/receipts \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "customerName": "ุฃุญูุฏ ูุญูุฏ",
    "customerPhone": "0501234567",
    "amount": 500,
    "paymentMethod": "cash",
    "description": "ุฏูุนุฉ ููุฏูุฉ"
  }'
```

#### ุงุฎุชุจุงุฑ ุฌูุจ ุงููุนุงููุงุช
```bash
curl http://localhost:5000/api/transactions \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### ุงุฎุชุจุงุฑ ุฅูุดุงุก ูุนุงููุฉ ูุฏููุฉ
```bash
curl -X POST http://localhost:5000/api/transactions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "type": "expense",
    "amount": 100,
    "description": "ูุตุงุฑูู ููุชุจูุฉ",
    "category": "other",
    "paymentMethod": "cash"
  }'
```

#### ุงุฎุชุจุงุฑ ุชุญููู ุฅูุตุงู ููุงุชูุฑุฉ
```bash
curl -X POST http://localhost:5000/api/receipts/RECEIPT_ID/convert-to-invoice \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "items": [
      {"description": "ุฎุฏูุฉ ุญุฌุฒ ุทูุฑุงู", "quantity": 1, "price": 500}
    ]
  }'
```

#### ุงุฎุชุจุงุฑ ุณุฌู ุงูุชุฏููู (Admin ููุท)
```bash
curl http://localhost:5000/api/audit \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### 3. ุงุฎุชุจุงุฑ ูู ุงููุงุฌูุฉ

1. **ุตูุญุฉ ุงูุฅูุตุงูุงุช** (`/control/receipts`)
   - ุฅูุดุงุก ุฅูุตุงู ุฌุฏูุฏ
   - ุนุฑุถ ุชูุงุตูู ุฅูุตุงู
   - ุชุญููู ุฅูุตุงู ููุงุชูุฑุฉ
   - ุฅูุบุงุก ุฅูุตุงู (Admin)

2. **ุตูุญุฉ ุงูุณุฌู ุงููุงูู** (`/control/transactions`)
   - ุนุฑุถ ูู ุงููุนุงููุงุช
   - ููุชุฑุฉ ุญุณุจ ุงูููุน/ุงูุชุตููู/ุงููุชุฑุฉ
   - ุฅูุดุงุก ูุนุงููุฉ ูุฏููุฉ
   - ุฅูุบุงุก ูุนุงููุฉ (Admin)

3. **ุตูุญุฉ ุณุฌู ุงูุชุฏููู** (`/control/audit-log`) - Admin ููุท
   - ุนุฑุถ ูู ุงูุนูููุงุช
   - ููุชุฑุฉ ุญุณุจ ููุน ุงูููุงู/ุงูุฅุฌุฑุงุก/ุงููุชุฑุฉ
   - ุนุฑุถ ุชูุงุตูู ุงูุชุบููุฑุงุช

### 4. ุงูุชุญูู ูู ุงูุชูุงูู

| ุงูุงุฎุชุจุงุฑ | ุงููุชูุฌุฉ ุงููุชููุนุฉ |
|----------|-----------------|
| ุฅูุดุงุก ุฅูุตุงู | ูุธูุฑ ูู ุงูุฅูุตุงูุงุช + ูููุดุฆ ูุนุงููุฉ ูู ุงูุณุฌู ุงููุงูู |
| ุฏูุนุฉ ุนูู ูุงุชูุฑุฉ | ุชุธูุฑ ูู ุณุฌู ุฏูุนุงุช ุงููุงุชูุฑุฉ + ูุนุงููุฉ ูู ุงูุณุฌู ุงููุงูู |
| ูุนุงููุฉ ูุฏููุฉ | ุชุธูุฑ ูู ุงูุณุฌู ุงููุงูู + ูุชุญุฏุซ ุงูุฑุตูุฏ |
| ุชุญููู ุฅูุตุงู | ุงูุฅูุตุงู ูุตุจุญ 'converted' + ุชููุดุฃ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ |
| ุฃู ุนูููุฉ | ุชูุณุฌู ูู ุณุฌู ุงูุชุฏููู |

---

## ุฃุฑูุงู ุงูุชุณูุณู ุงูุชููุงุฆูุฉ

| ุงูููุน | ุงูุตูุบุฉ | ูุซุงู |
|-------|-------|------|
| ุงููุนุงููุงุช | TRX-YYYYMMDD-XXX | TRX-20260201-001 |
| ุงูุฅูุตุงูุงุช | REC-YYYYMMDD-XXX | REC-20260201-001 |
| ุงูููุงุชูุฑ | INV-YYYYMMDD-XXX | INV-20260201-001 |

---

## ุชุตูููุงุช ุงููุนุงููุงุช

| ุงูุชุตููู | ุงููุตู |
|---------|-------|
| `appointment_payment` | ุฏูุนุฉ ููุนุฏ |
| `invoice_payment` | ุฏูุนุฉ ูุงุชูุฑุฉ |
| `expense` | ูุตุฑูู ุนุงู |
| `salary` | ุฑุงุชุจ |
| `commission` | ุนูููุฉ |
| `refund` | ุงุณุชุฑุฏุงุฏ |
| `other` | ุฃุฎุฑู |

---

## ุทุฑู ุงูุฏูุน

| ุงูุทุฑููุฉ | ุงููุตู |
|---------|-------|
| `cash` | ููุฏู |
| `card` | ุจุทุงูุฉ |
| `transfer` | ุชุญููู ุจููู |

---

## ููุงุญุธุงุช ูููุฉ

1. **MongoDB Sessions**: ุฌููุน ุงูุนูููุงุช ุงููุงููุฉ ุชุณุชุฎุฏู sessions ูุถูุงู atomicity
2. **ุงูุฃุฑุตุฏุฉ ูููุตูุฉ**: ูู ุทุฑููุฉ ุฏูุน ููุง ุฑุตูุฏ ูููุตู (cash, card, transfer)
3. **ุณุฌู ุงูุชุฏููู**: ูุญูุธ ููู before/after ููู ุชุนุฏูู
4. **ูุง ุญุฐู ูุนูู**: ุงููุนุงููุงุช ูุงูุฅูุตุงูุงุช ุชููุบู ููุง ุชูุญุฐู (ููุญูุงุธ ุนูู ุงูุณุฌู)

---

## ุชุฑุญูู ุงูุจูุงูุงุช ุงููุฏููุฉ (Migration)

### ุชุดุบูู Migration Script

ูููู ุงูุจูุงูุงุช ูู CashRegister ุงููุฏูู ุฅูู ุงููุธุงู ุงูุฌุฏูุฏ:

```bash
cd server
node src/migrations/migrateFinancialData.js
```

### ูุง ููุนูู ุงูุณูุฑุจุช:
1. ูุฌูุจ ุฌููุน ูุนุงููุงุช CashRegister.transactions
2. ููุดุฆ Transaction ููู ูุนุงููุฉ
3. ููุดุฆ Receipt ููุนุงููุงุช `appointment_payment`
4. ูุญุงูุธ ุนูู ุงูุนูุงูุงุช (appointment, customer, invoice)
5. ูุถูู metadata ูููุนุงููุงุช ุงููุฑุญููุฉ ูุชุฌูุจ ุงูุชูุฑุงุฑ

### ุงูุชูุงูู ูุน ุงููุธุงู ุงููุฏูู

ุงููุธุงู ุงูุฌุฏูุฏ ูุฏุนู ุนุฑุถ ุงูุจูุงูุงุช ูู ููุง ุงููุธุงููู:
- ุงููุนุงููุงุช ุงูุฌุฏูุฏุฉ ูู `Transaction` model
- ุงููุนุงููุงุช ุงููุฏููุฉ ูู `CashRegister.transactions`
- ูุชู ุฏูุฌูุง ูุนุฑุถูุง ูู ุตูุญุฉ ุงูุณุฌู ุงููุงูู

---

## ุงููููู ุงูุฌุฏูุฏ ูู Sidebar

```
๐ ููุญุฉ ุงูุชุญูู
๐ ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ
๐ ุงููุณูุฏุงุช ูุงูุชุฐุงููุฑ
๐ฅ ุงูุนููุงุก
๐ข ุงูุฃูุณุงู / ุงูุณูุงุฑุงุช
โ๏ธ ุงูุฑุญูุงุช
๐ ุงูุญุฌูุฒุงุช
โโโโโโโโโโโโโโโโโ
๐ ุงูููุงุชูุฑ ูุงูุฅูุตุงูุงุช    โ  (ูุงุจู ูููุชุญ)
   โโ ๐ ุงูููุงุชูุฑ
   โโ ๐งพ ุงูุฅูุตุงูุงุช
๐ฐ ุงููุงููุฉ                โ  (ูุงุจู ูููุชุญ)
   โโ ๐ ุงูุณุฌู ุงููุงูู
   โโ ๐ ุงูุชูุงุฑูุฑ         ๐ (Admin)
   โโ ๐ ุณุฌู ุงูุชุฏููู      ๐ (Admin)
โโโโโโโโโโโโโโโโโ
๐งโ๐ผ ุงูููุธููู              ๐ (Admin)
โ๏ธ ุงูุฅุนุฏุงุฏุงุช
```

---

## ุงูุฏุนู

ูู ุญุงูุฉ ูุฌูุฏ ูุดุงูู ุฃู ุงุณุชูุณุงุฑุงุชุ ุชุญูู ูู:
1. ุฃู ุงูุณูุฑูุฑ ูุนูู ุนูู ุงููููุฐ ุงูุตุญูุญ
2. ุฃู ุงูุชููู ุตุงูุญ ููู ุชูุชูู ุตูุงุญูุชู
3. ุฃู ุงููุณุชุฎุฏู ูุฏูู ุงูุตูุงุญูุงุช ุงููุทููุจุฉ
4. ุณุฌูุงุช ุงูุฃุฎุทุงุก ูู console ุงูุณูุฑูุฑ

### ุงููุดุงูู ุงูุดุงุฆุนุฉ

| ุงููุดููุฉ | ุงูุญู |
|---------|------|
| ุงูุฅูุตุงูุงุช ูุง ุชุธูุฑ | ูู ุจุชุดุบูู migration script |
| ุงูุณุฌู ุงููุงูู ูุงุฑุบ | ุชุญูู ูู ุฃู `includeOld=true` ูู ุงูุทูุจ |
| ุฎุทุฃ ูู ุฅูุดุงุก ุฅูุตุงู | ุชุญูู ูู ูุฌูุฏ Settings ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช |
